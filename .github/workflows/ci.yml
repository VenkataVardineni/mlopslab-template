name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  reproducibility-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-lock.txt
    
    - name: Install DVC
      run: |
        pip install dvc
    
    - name: Run DVC pipeline (smoke test)
      run: |
        # Run a minimal pipeline to test reproducibility
        # Note: This will download data and run full pipeline
        # For faster CI, you might want to use a smaller dataset
        dvc repro
    
    - name: Check metrics exist
      run: |
        if [ ! -f metrics/metrics.json ]; then
          echo "Error: metrics/metrics.json not found"
          exit 1
        fi
    
    - name: Check metrics against thresholds
      run: |
        python scripts/check_metrics.py
    
    - name: Compare metrics with baseline (if available)
      run: |
        # Try to compare with previous commit if available
        if git rev-parse HEAD~1 > /dev/null 2>&1; then
          echo "Comparing metrics with previous commit..."
          dvc metrics diff HEAD~1 HEAD || true
        else
          echo "No previous commit to compare with"
        fi

